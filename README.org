#+TITLE: Zeek to Nix Flake's feature

* Build Zeek with nix-build -> result/bin/zeek (Current version)
- nix run zeekctl app with flake
- [[*create zeek dynamic dir to /var/lib/zeek][create zeek dynamic dir to /var/lib/zeek]] before you run command with ~zeekctl deploy~
  nix run to zeekctl
#+begin_src sh :async t :exports both :results output
nix run
#+end_src

- with native nix-build -> ./result/bin/zeek -N


#+begin_src sh :async t :exports both :results output
# flake feature
nix build
# or
nix-build
#+end_src

* Build Zeek Env with nix-shell(shell mode) - TLS version
#+begin_src sh :async t :exports both :results output
nix develop
# or
nix-shell
#+end_src

* Deploy Zeek with NixOS (flakes)
#+begin_src nix :async t :exports both :results output
{
  inputs =
    {
      zeek-nix = {
        url = "github:hardenedlinux/zeek-nix/main";
        inputs.nixpkgs.follows = "nixos";
      };
      "..."
        };
        outputs = { self, zeek-nix, nixpkgs, ... }: {
        nixosConfigurations.myConfig = nixpkgs.lib.nixosSystem {
          system = "...";

          modules = [
            zeek-nix.nixosModules.zeek
            ({ ... }: {
              services.zeek = {
                enable = true;
                standalone = true;
                interface = "eno1";
                listenAddress = "localhost";
                package = pkgs.zeek.override {
                  plugins = [
                    "zeek-plugin-kafka"
                    "zeek-plugin-spicy"
                    "zeek-plugin-community-id"
                    "zeek-plugin-af_packet"
                    "zeek-plugin-postgresql"
                  ];
                };
                privateScript = ''
                  @load /home/gtrun/project/hardenedlinux-zeek-script/scripts/zeek-query.zeek
                  @load /home/gtrun/project/hardenedlinux-zeek-script/scripts/log-passwords.zeek
                '';
              };
            })
          ];
        };
      };
    }
#+end_src


* create zeek dynamic dir to ~/var/lib/zeek~
:BACKLINKS:
[2020-10-09 Fri 19:35] <- [[*Build Zeek with nix-build -> result/bin/zeek (Current version)][Build Zeek with nix-build -> result/bin/zeek (Current version)]]
:END:
#+begin_src sh :async t :exports both :results output
sudo bash ./pre-run-zeekctl.sh
#+end_src



* Optional: using cachix to speed up binary build
#+begin_src sh :async t :exports both :results output
nix-env -iA cachix -f https://cachix.org/api/v1/install
cachix use zeek
#+end_src
* Test Spicy

#+begin_src sh :async t :exports both :results output
./result/bin/spicyc -j misc/hello.spicy
#+end_src

#+RESULTS:
: Hello, world!

- check spicy plugins
#+begin_src sh :async t :exports both :results output
./result/bin/zeek -NN _Zeek::Spicy
#+end_src

#+RESULTS:
